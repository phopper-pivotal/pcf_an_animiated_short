# Lab 2 - Binding to Cloudfoundry Services

The _Workshop_ application was designed to illustrate the ease with which data services can be bound to and utilized by applications running on Pivotal Cloud Foundry.
In this lab, we'll be binding the application to a MySQL databases.

Pivotal Cloud Foundry services are managed through two primary types of operations:

**Create/Delete:** These operations create or delete instances of a service.
For a database this could mean creating/deleting a schema in an existing multitenant cluster or creating/deleting a dedicated database cluster.

**Bind/Unbind:** These operations create or delete unique credential sets for an existing service instance that can then be injected into the environment of an application instance.

## A Bit of Review

Your instance of the sample _Workshop_ should not be running after the steps completed in lab 1.  Make sure to change to the _cf-spring-mvc-boot_ sample application directory.  For this lab we will be using the Java application.  Deploy the application:

`$ cf push <some-unique-appname>`

After the application deploys and starts, visit the application in your browser by hitting the route that was generated by the CLI.  Currently, this data is being retrieved from an in-memory HSQL database running within the JVM.  Let's change that.

![Alt](lab.png)

## The Services Marketplace

There are two ways to discover what services are available on Pivotal Cloudfoundry.
The first is available on any instance of Cloud Foundry: the CLI. Just type:

`$ cf marketplace`

and you'll get a list of services, their available plans, and descriptions. On Pivotal Cloudfoundry, the "free" tier of plans is normally the first one listed.

The second way is specific to Pivotal Cloud Foundry's Apps Manager UI. If you haven't already, login to it by visiting [Apps Mgr](apps.)

Click on the "Marketplace" link in the left navbar:

![Alt](lab1.png)

and you'll see the same (or a similar if on Pivotal Web Services) service/plan/description listing in the browser:

![Alt](lab2.png)

## Creating and Binding to a Service Instance

Let's begin by creating a MySQL service instance.
From the Apps Manager UI service marketplace, select _MySQL for Pivotal Cloud Foundry v2_, select the db-small plan, and provide an instance name

In the drop-down list next to _Add To Space_ select the space where you deployed the application

In the drop-down list next to _Bind To App_ select your workshop application

Select _Create_ to create the service instance

![Alt](lab3.png)

Notice the admonition to `Use 'cf restage' to ensure your env variable changes take effect`.
Let's take a look at the environment variables for our application. We can do this by viewing to the homepage of the application.
Here we will see a printout of the environment information.  Take note of what is contained in the section _Bound Services_.  It's an empty JSON document!

Now let's _restage_ the application, which cycles our application back through the staging/buildpack process before redeploying the application. In this case, we could accomplish the same goal by only _restarting_ the application via `cf restart cf-spring-mvc-boot`.

A _restage_ is generally recommended because Cloud Foundry buildpacks also have access to injected environment variables and can install or configure things differently based on their values.]

`$ cf restage cf-spring-mvc-boot`

Once the application is running again, let's verify that JDBC connection information to the MySQL instance we created.

`$ cf env cf-spring-mvc-boot`

~~~~
System-Provided:
{
 "VCAP_SERVICES": {
  "app-autoscaler": [
   {
    "binding_name": null,
    "credentials": {},
    "instance_name": "autoscale-dev",
    "label": "app-autoscaler",
    "name": "autoscale-dev",
    "plan": "standard",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [
     "cfapi",
     "runtime",
     "autoscaling"
    ],
    "volume_mounts": []
   }
  ],
  "p.mysql": [
   {
    "binding_name": null,
    "credentials": {
     "hostname": "10.193.164.232",
     "jdbcUrl": "jdbc:mysql://10.193.164.232:3306/service_instance_db?user=9f8a3662c30545a7897784529e244216\u0026password=0ghqzb26gjnz1k6x",
     "name": "service_instance_db",
     "password": "0ghqzb26gjnz1k6x",
     "port": 3306,
     "uri": "mysql://9f8a3662c30545a7897784529e244216:0ghqzb26gjnz1k6x@10.193.164.232:3306/service_instance_db?reconnect=true",
     "username": "9f8a3662c30545a7897784529e244216"
    },
    "instance_name": "mydb",
    "label": "p.mysql",
    "name": "mydb",
    "plan": "db-small",
    "provider": null,
    "syslog_drain_url": null,
    "tags": [
     "mysql"
    ],
    "volume_mounts": []
   }
  ]
 }
}

{
 "VCAP_APPLICATION": {
  "application_id": "3f2818e4-5d4c-492b-8c65-2eeb5d41efbd",
  "application_name": "cf-scale-boot",
  "application_uris": [
   "cf-scale-boot.cfapps.haas-100.pez.pivotal.io"
  ],
  "application_version": "ca11dfc3-e3c7-4c2e-86f0-dd7daa6618d5",
  "cf_api": "https://api.run.haas-100.pez.pivotal.io",
  "limits": {
   "disk": 1024,
   "fds": 16384,
   "mem": 1024
  },
  "name": "cf-scale-boot",
  "space_id": "47ff077e-2171-4f13-aae7-f91fa5254a33",
  "space_name": "dev",
  "uris": [
   "cf-scale-boot.cfapps.haas-100.pez.pivotal.io"
  ],
  "users": null,
  "version": "ca11dfc3-e3c7-4c2e-86f0-dd7daa6618d5"
 }
}

No user-defined env variables have been set

No running env variables have been set

No staging env variables have been set
~~~~

You may also verify your service was provisioned in the Apps Manager UI by clicking on your application and selecting the _Services_ tab.

![Alt](lab4.png)

You should now see the service created in step 1 listed.

You may also verify your service was provisioned using the CLI:

`$ cf services`

You should now see the service created in step 1 listed and your application listed as a bound app.